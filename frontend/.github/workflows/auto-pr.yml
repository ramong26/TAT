name: Auto Create PR with Gemini

on:
  push:
    branches-ignore:
      - main # main ì œì™¸, ë‚˜ë¨¸ì§€ ëª¨ë“  ë¸Œëœì¹˜ì—ì„œ ì‹¤í–‰

env:
  TARGET_BRANCH: main
  SOURCE_BRANCH: ${{ github.ref_name }}

jobs:
  create-pull-request:
    runs-on: ubuntu-latest

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # merge-base ê³„ì‚° ìœ„í•´ ì „ì²´ íˆìŠ¤í† ë¦¬ í•„ìš”

      # 2. GitHub CLI ì„¤ì¹˜
      - name: Install GitHub CLI
        run: sudo apt-get install gh -y

      # 3. ê¸°ì¡´ PR ì¡´ì¬ ì—¬ë¶€ í™•ì¸
      - name: Check for existing PR
        id: check-pr
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          existing_pr=$(gh pr list \
            --head "$SOURCE_BRANCH" \
            --base "$TARGET_BRANCH" \
            --json number \
            --jq '.[0].number')

          if [ -n "$existing_pr" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "PR already exists: #$existing_pr"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      # 4. Gemini CLI ì„¤ì¹˜
      - name: Install Gemini CLI
        if: steps.check-pr.outputs.exists == 'false'
        run: |
          npm install -g @google/gemini-cli

      # 5. PR ì œëª©/ë³¸ë¬¸ ìƒì„±
      - name: Generate PR Title and Body
        if: steps.check-pr.outputs.exists == 'false'
        id: generate-pr
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          bash .github/scripts/generate-pr-description.sh \
            "$TARGET_BRANCH" \
            "$SOURCE_BRANCH"

      # 6. PR ìƒì„±
      - name: Create Pull Request
        if: steps.check-pr.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
          TZ: Asia/Seoul
        run: |
          gh pr create \
            --base "$TARGET_BRANCH" \
            --head "$SOURCE_BRANCH" \
            --title "${{ steps.generate-pr.outputs.title }}" \
            --body "${{ steps.generate-pr.outputs.body }}

          ---
          ğŸ¤– Gemini AIë¡œ ìë™ ìƒì„±ëœ PR
          ìƒì„± ì‹œê°„: $(date +'%Y-%m-%d %H:%M:%S')"
